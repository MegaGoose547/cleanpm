<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <a href="index.html" class="topbar-button discord-button">‚Üê Back to Gallery</a>
    <h1 class="topbar-title">Admin Panel</h1>
    <div style="width: 140px;"></div>
  </div>

  <!-- Admin Container -->
  <div class="admin-container">

    <!-- üîê Login Section -->
    <div id="auth-section" class="admin-card">
      <h2>Login</h2>
      <form id="login-form">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit" class="random-button">Login</button>
        <p id="login-error" class="error-text"></p>
      </form>
    </div>

    <!-- ‚úÖ Admin Panel -->
    <div id="admin-section" class="admin-card" style="display:none;">
      <h2>Add New Project</h2>
      <form id="project-form">
        <input type="file" id="image-file" accept="image/*" required>
        <input type="url" id="url" placeholder="Project URL" required>
        <input type="text" id="text" placeholder="Display Text">
        <button type="submit" class="random-button">Add Project</button>
      </form>

      <button id="logout-btn" class="sort-button" style="margin-top: 1rem;">Logout</button>

      <hr style="margin: 2rem 0; border-color: var(--border);">

      <h2>Manage Projects</h2>
      <div id="project-list" class="admin-card"></div>
    </div>

  </div>

  <!-- Supabase JS -->
  <script>
    const client = window.supabase.createClient(
      'https://ubrsdotiwcmiyznvzhcw.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVicnNkb3Rpd2NtaXl6bnZ6aGN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5ODEwMzksImV4cCI6MjA2OTU1NzAzOX0.n5p9dxhNv5u7GyvJ3e2xignsJDyOcBjsFWV6FCwxeVQ'
    );

    const authSection = document.getElementById('auth-section');
    const adminSection = document.getElementById('admin-section');
    const loginForm = document.getElementById('login-form');
    const projectForm = document.getElementById('project-form');
    const logoutBtn = document.getElementById('logout-btn');
    const loginError = document.getElementById('login-error');
    const projectList = document.getElementById('project-list');

    async function checkUser() {
      const { data: { session } } = await client.auth.getSession();
      if (session && session.user) {
        authSection.style.display = 'none';
        adminSection.style.display = 'block';
        await loadProjects();
      } else {
        authSection.style.display = 'block';
        adminSection.style.display = 'none';
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const { data, error } = await client.auth.signInWithPassword({ email, password });

      if (error) {
        loginError.textContent = "Login failed: " + error.message;
      } else {
        loginError.textContent = "";
        await checkUser();
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await client.auth.signOut();
      await checkUser();
    });

    projectForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const url = document.getElementById('url').value;
      const text = document.getElementById('text').value;
      const fileInput = document.getElementById('image-file');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select an image.');
        return;
      }

      const filename = `${Date.now()}-${file.name}`;
      const { error: uploadError } = await client.storage
        .from('project-images')
        .upload(filename, file);

      if (uploadError) {
        alert('Image upload failed: ' + uploadError.message);
        return;
      }

      const { error: insertError } = await client.from('projects').insert([
        { filename, url, text }
      ]);

      if (insertError) {
        alert('Project insert failed: ' + insertError.message);
        return;
      }

      alert('Project added successfully!');
      projectForm.reset();
      await loadProjects();
    });

    async function loadProjects() {
      const { data: projects, error } = await client.from('projects').select('*').order('id', { ascending: false });

      projectList.innerHTML = '';

      if (error) {
        projectList.innerHTML = `<p style="color:red;">Error loading projects: ${error.message}</p>`;
        return;
      }

      if (!projects.length) {
        projectList.innerHTML = '<p>No projects found.</p>';
        return;
      }

      projects.forEach(project => {
        const div = document.createElement('div');
        div.className = 'project-entry';
        div.innerHTML = `
          <p><strong>${project.text || '(no title)'}</strong><br>
          <a href="${project.url}" target="_blank">${project.url}</a></p>
          <button class="sort-button delete-btn" data-id="${project.id}" data-filename="${project.filename}">Delete</button>
        `;
        projectList.appendChild(div);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const filename = btn.getAttribute('data-filename');

          if (!confirm('Are you sure you want to delete this project?')) return;

          const { error: deleteError } = await client.from('projects').delete().eq('id', id);
          const { error: storageError } = await client.storage.from('project-images').remove([filename]);

          if (deleteError || storageError) {
            alert('Delete failed:\n' + (deleteError?.message || '') + '\n' + (storageError?.message || ''));
            return;
          }

          alert('Project deleted.');
          await loadProjects();
        });
      });
    }

    checkUser();
  </script>
</body>
</html>
